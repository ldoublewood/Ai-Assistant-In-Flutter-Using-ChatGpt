# 语音识别功能使用指南

## 功能概述

本应用支持基于SenseVoice-Api的远程语音识别功能，可以将用户的语音输入转换为文字，然后发送给AI助手进行对话。

## 配置步骤

### 1. 启动SenseVoice服务器

首先需要在本地或远程服务器上启动SenseVoice-Api服务：

```bash
# 使用Docker启动（推荐）
docker run -d -p 8000:8000 sensevoice/sensevoice-api:latest

# 或者从源码启动
git clone https://github.com/HG-ha/SenseVoice-Api.git
cd SenseVoice-Api
python app.py
```

### 2. 配置应用设置

1. 打开应用，进入"语音识别设置"界面
2. 启用"使用远程语音识别"开关
3. 输入SenseVoice服务器地址（默认：http://localhost:8000）
4. 选择识别语言（建议选择"自动检测"）
5. 点击"测试连接"验证服务器连接
6. 保存设置

### 3. 权限设置

确保应用已获得以下权限：
- 麦克风权限：用于录制语音
- 存储权限：用于临时保存音频文件

## 使用方法

### 基本使用

1. 在聊天界面，点击麦克风按钮开始语音输入
2. 对着设备说话，应用会显示实时识别结果
3. 说话完成后，应用会自动停止录音并发送到远程服务器进行精确识别
4. 识别结果会自动填入输入框，可以直接发送给AI助手

### 测试功能

1. 在语音设置界面，点击"测试功能"按钮
2. 在测试界面可以：
   - 运行诊断测试：检查配置和权限状态
   - 测试语音输入：验证完整的语音识别流程

## 技术实现

### 音频录制

- 使用`record`插件进行音频录制
- 录制格式：PCM 16-bit WAV
- 临时文件存储在应用缓存目录

### 语音识别流程

1. **权限检查**：验证麦克风权限
2. **服务器连接**：检查SenseVoice服务器可用性
3. **开始录音**：使用record库录制音频文件
4. **实时反馈**：使用本地speech_to_text提供实时识别反馈
5. **远程识别**：将录制的音频文件发送到SenseVoice服务器
6. **结果处理**：解析服务器响应并显示识别结果
7. **清理资源**：删除临时音频文件

### API接口

SenseVoice-Api使用以下接口：

```
POST /extract_text
Content-Type: multipart/form-data

参数：
- file: 音频文件（支持WAV、MP3、FLAC、M4A等格式）

响应格式：
{
  "message": "input processed successfully",
  "results": "识别出的文字内容",
  "label_result": "<|zh|><|NEUTRAL|><|Speech|><|withitn|>识别出的文字内容"
}

错误响应格式：
{
  "detail": "错误详细信息"
}
```

### 新功能特性

- **多语言识别**：支持超过50种语言，识别效果优于Whisper模型
- **情感识别**：可以识别语音中的情感（快乐、悲伤、愤怒、中性等）
- **音频事件检测**：可以检测音乐、掌声、笑声、哭声、咳嗽、喷嚏等音频事件
- **高效推理**：10秒音频推理仅耗时70ms，性能优异

## 故障排除

### 常见问题

1. **无法连接到服务器**
   - 检查SenseVoice服务器是否正在运行
   - 验证服务器地址是否正确
   - 检查网络连接

2. **录音失败**
   - 检查麦克风权限是否已授予
   - 确认设备麦克风功能正常
   - 重启应用重新初始化录音器

3. **识别结果为空**
   - 确保说话声音足够清晰
   - 检查录音环境是否过于嘈杂
   - 验证音频文件是否正确生成

4. **权限被拒绝**
   - 在设备设置中手动授予麦克风权限
   - 重启应用使权限生效

### 调试方法

1. 使用测试界面的诊断功能
2. 查看应用日志输出
3. 检查SenseVoice服务器日志
4. 验证音频文件是否正确生成

## 性能优化

### 音频质量

- 建议在安静环境中使用
- 保持设备麦克风清洁
- 说话时保持适当距离

### 网络优化

- 使用稳定的网络连接
- 考虑在本地网络部署SenseVoice服务器
- 音频文件大小控制在30MB以内

## 更新日志

### v1.0.2
- 添加了真实的音频录制功能
- 修复了语音输入后未发送请求的问题
- 改进了错误处理和用户反馈
- 添加了测试和诊断功能

### 已知限制

- 目前仅支持远程语音识别
- 需要网络连接才能使用
- 音频文件大小限制为30MB
- 录音时长建议不超过30秒